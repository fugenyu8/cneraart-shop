/**
 * 命理解读报告生成 - 本地模板引擎
 * 完全本地运行，不依赖任何外部 LLM API
 * 根据计算结果匹配预设的解读文案库，组合生成完整报告
 */

interface CalculationResult {
  [key: string]: {
    score: number;
    category: string;
    interpretations: string[];
  };
}

interface AIInterpretationResult {
  overallSummary: string;
  sections: Array<{
    title: string;
    content: string;
    score: number;
  }>;
}

// ============= 面相解读文案库 =============

const FACE_PALACE_TEMPLATES: Record<string, Record<string, string[]>> = {
  命宫: {
    吉: [
      "您的命宫印堂开阔明亮，此乃上佳之相。印堂为面相之首，主一生运势总纲。印堂宽阔者，心胸豁达，气度不凡，遇事能从容应对。古相书云:\"印堂明润如镜，一生富贵无忧\"。您的印堂光洁无纹，说明早年运势顺遂，中年事业有成，晚年安享太平。建议保持乐观心态，广结善缘，运势自然亨通。",
      "命宫印堂宽阔饱满，气色明润，此为福禄之相。印堂主人一生的精神状态和运势走向，您的印堂呈现出积极向上的气象，预示着人生道路平坦顺畅。在事业上容易得到贵人相助，在感情上也能遇到良缘。建议多行善事，积德累福，好运将持续伴随。",
    ],
    中: [
      "您的命宫印堂宽度适中，整体运势平稳。印堂虽非特别宽阔，但气色尚可，说明您性格沉稳，做事有条理。人生虽不会有大起大落，但只要勤勉努力，必能积少成多，稳步前进。建议平时多注意调节情绪，保持心境平和，运势会逐渐好转。",
      "命宫表现中等，印堂区域气色平和。这说明您的运势处于稳定发展期，虽然不会有突如其来的大运，但也不会遭遇重大挫折。建议在日常生活中注重修身养性，提升自身能力，等待时机成熟，必能一飞冲天。",
    ],
    凶: [
      "您的命宫印堂略显狭窄，需要多加留意。印堂偏窄者，容易思虑过多，给自己增添不必要的压力。但命运掌握在自己手中，通过调整心态，放宽心胸，完全可以改善运势。建议多参加户外活动，开阔视野，结交正能量的朋友，运势自然会好转。",
      "命宫区域显示需要注意调理。印堂气色偏暗，可能近期压力较大或休息不足。建议注意作息规律，保持充足睡眠，适当进行冥想或瑜伽等放松活动。同时可以在家中摆放一些绿色植物，改善居住环境的气场，有助于运势提升。",
    ],
  },
  财帛宫: {
    吉: [
      "您的财帛宫鼻相端正饱满，鼻梁挺直，鼻头圆润有肉，此为聚财之相。古语云:\"鼻为财帛宫，鼻正财运通\"。您的鼻相显示财运亨通，善于理财，中年以后财富积累丰厚。鼻翼丰满说明偏财运也不错，可能会有意外之财。建议合理规划财务，稳健投资，财富将持续增长。",
      "财帛宫呈现出极佳的聚财之象。鼻梁高挺代表事业心强，鼻头圆润代表善于守财。您天生具有良好的财商，能够在商业活动中敏锐地把握机会。建议在稳健的基础上适当拓展投资渠道，同时注意积德行善，财运将更加旺盛。",
    ],
    中: [
      "您的财帛宫鼻相中等，财运平稳。鼻梁高度适中，鼻头尚算圆润，说明您有一定的理财能力，但需要更加努力才能积累可观的财富。建议培养储蓄习惯，学习理财知识，避免冲动消费。中年以后财运会逐渐好转，耐心等待时机。",
      "财帛宫表现平稳，说明您的财运处于稳定增长期。虽然不会一夜暴富，但通过勤劳努力，财富会稳步积累。建议注重提升专业技能，增加收入来源，同时合理控制支出，财务状况将逐渐改善。",
    ],
    凶: [
      "您的财帛宫显示财运方面需要多加注意。鼻梁偏低或鼻头偏尖，说明在理财方面可能不够谨慎。但这并非不可改变，通过后天的努力和学习，完全可以提升财运。建议养成记账习惯，避免高风险投资，多向成功人士学习理财经验。同时可以在办公桌上摆放招财物品，提升财运气场。",
      "财帛宫提示需要在财务管理上更加谨慎。近期可能面临一些财务压力，建议开源节流，避免不必要的大额支出。同时注意防范财务风险，不要轻信他人的投资建议。通过脚踏实地的努力，财运终将好转。",
    ],
  },
  官禄宫: {
    吉: [
      "您的官禄宫额头宽阔饱满，此为事业有成之相。额头主智慧和事业运，宽阔的额头说明您思维敏捷，有远见卓识，在事业上容易取得成就。古相书云:\"天庭饱满贵人多\"，您在职场上容易得到上司赏识和同事支持。建议把握机会，勇于担当，事业前途一片光明。",
      "官禄宫呈现出优秀的事业运势。额头高广饱满，说明您具有领导才能和战略眼光。在工作中能够高瞻远瞩，做出正确的决策。建议在事业发展中保持谦逊，广纳建言，同时注重团队建设，事业将更上一层楼。",
    ],
    中: [
      "您的官禄宫额头表现中等，事业运势平稳。虽然额头不算特别宽阔，但整体气色尚可，说明您在事业上有一定的发展潜力。建议多学习新知识，提升专业能力，同时注重人际关系的维护，事业发展会逐渐加速。",
      "官禄宫显示事业运处于蓄力期。目前可能还没有达到理想的高度，但只要持续努力，终将迎来事业的转折点。建议制定清晰的职业规划，一步一个脚印地前进，同时保持学习的热情，机会总是留给有准备的人。",
    ],
    凶: [
      "您的官禄宫额头略显不足，事业方面需要更多努力。额头偏窄或偏低，说明在事业发展中可能会遇到一些阻碍。但这恰恰是磨练意志的机会，通过不断学习和积累经验，完全可以克服困难。建议多向前辈请教，培养耐心和毅力，事业终将有所突破。",
    ],
  },
  田宅宫: {
    吉: [
      "您的田宅宫眉眼距离适宜，此为有房有产之相。眉眼之间宽阔明亮，说明您在置业方面运势不错，中年以后容易拥有自己的房产。同时也代表家庭和睦，生活安定。建议在条件允许时适当投资房产，长期来看收益可观。",
    ],
    中: [
      "您的田宅宫眉眼距离中等，置业运势平稳。虽然不会轻易获得大量房产，但通过努力工作和合理规划，完全可以实现安居乐业的目标。建议做好长期的财务规划，量力而行地进行置业投资。",
    ],
    凶: [
      "您的田宅宫眉眼距离偏窄，在置业方面需要更加谨慎。建议不要急于购置房产，先做好充分的市场调研和财务评估。同时注意维护好现有的居住环境，保持家庭和谐，运势自然会好转。",
    ],
  },
  妻妾宫: {
    吉: [
      "您的妻妾宫眼尾饱满平滑，此为感情美满之相。眼尾区域光洁无纹，说明您在感情方面运势良好，容易遇到志同道合的伴侣。婚后生活和谐美满，夫妻感情深厚。建议珍惜身边人，用心经营感情，幸福将长久相伴。",
    ],
    中: [
      "您的妻妾宫表现中等，感情运势平稳。在感情方面可能需要更多的耐心和付出，但只要真心对待，终将收获美好的爱情。建议在择偶时注重内在品质，不要过于看重外在条件，真诚的感情才能经得起时间的考验。",
    ],
    凶: [
      "您的妻妾宫显示感情方面需要多加注意。眼尾区域可能有细纹，提示在感情中可能会遇到一些波折。但这并非不可化解，通过提升自身魅力，学会沟通和包容，感情运势完全可以改善。建议多参加社交活动，扩大交友圈，缘分自然会到来。",
    ],
  },
  儿女宫: {
    吉: [
      "您的儿女宫泪堂饱满润泽，此为子女缘厚之相。泪堂丰满说明您与子女的缘分深厚，子女将来也会有出息。在教育子女方面，您有天生的耐心和智慧。建议用爱心和耐心培养下一代，他们将成为您的骄傲。",
    ],
    中: [
      "您的儿女宫泪堂表现中等，子女缘分尚可。在养育子女方面需要投入更多的精力和耐心。建议注重与子女的沟通，了解他们的需求和想法，建立良好的亲子关系。",
    ],
    凶: [
      "您的儿女宫泪堂略显不足，在子女方面需要更多关注。建议在教育子女时多一些耐心和理解，避免过于严厉。同时注意自身的健康，保持良好的生活习惯，这对子女运也有积极的影响。",
    ],
  },
  兄弟宫: {
    吉: [
      "您的兄弟宫眉毛浓密有型，此为人缘广泛之相。眉毛浓密且排列整齐，说明您人际关系良好，朋友众多，在需要帮助时总能得到他人的支持。建议珍惜友谊，真诚待人，您的社交网络将成为人生的重要资源。",
    ],
    中: [
      "您的兄弟宫眉毛表现中等，人际关系平稳。虽然朋友不算特别多，但都是真心相交的知己。建议主动拓展社交圈，参加各种社交活动，结识更多志同道合的朋友。",
    ],
    凶: [
      "您的兄弟宫眉毛偏淡或稀疏，在人际关系方面需要更多努力。建议学习社交技巧，主动与人交流，同时注意维护现有的友谊关系。真诚和善良是最好的社交名片。",
    ],
  },
  福德宫: {
    吉: [
      "您的福德宫天仓饱满，此为福泽深厚之相。天仓丰满说明您一生福气不断，晚年生活安逸幸福。您天性乐观，心态平和，能够享受生活中的美好。建议继续保持积极的生活态度，多行善事，福报将更加丰厚。",
    ],
    中: [
      "您的福德宫天仓表现中等，福泽尚可。通过积极的生活态度和善良的行为，可以不断积累福报。建议多参与公益活动，帮助他人，同时注重精神层面的修养，内心的富足才是真正的福气。",
    ],
    凶: [
      "您的福德宫天仓略显不足，需要在精神修养方面多下功夫。建议培养一些有益的兴趣爱好，如读书、冥想、书法等，提升内在修养。同时多行善事，积德累福，运势将逐渐好转。",
    ],
  },
  迁移宫: {
    吉: [
      "您的迁移宫额角隆起有力，此为出行顺利之相。额角饱满说明您在外出发展、旅行、搬迁等方面运势良好。如果有出国或异地发展的计划，可以放心实施。建议多出去走走，开阔视野，外面的世界将给您带来更多机遇。",
    ],
    中: [
      "您的迁移宫额角表现中等，出行运势平稳。在外出发展方面需要做好充分的准备和规划。建议出行前多做功课，了解目的地的情况，做好万全的准备，旅途将更加顺利。",
    ],
    凶: [
      "您的迁移宫额角略显不足，出行方面需要多加注意。建议近期减少不必要的长途旅行，如果必须出行，要做好详细的计划和安全措施。同时可以在家中摆放一些旅行平安的吉祥物。",
    ],
  },
  疾厄宫: {
    吉: [
      "您的疾厄宫山根饱满挺直，此为健康长寿之相。山根为鼻梁上部，连接额头和鼻子，饱满挺直说明您身体底子好，免疫力强，不容易生病。建议继续保持良好的生活习惯，规律作息，适当运动，健康将长久相伴。",
    ],
    中: [
      "您的疾厄宫山根表现中等，健康状况总体尚可。建议注意日常保健，定期体检，保持规律的作息和适量的运动。饮食方面注意营养均衡，少吃油腻和辛辣食物。",
    ],
    凶: [
      "您的疾厄宫山根略显低平，健康方面需要多加关注。建议加强体育锻炼，增强体质，同时注意饮食健康和作息规律。定期进行健康检查，做到早发现早治疗。保持乐观的心态也是健康的重要保障。",
    ],
  },
  父母宫: {
    吉: [
      "您的父母宫日月角高耸明亮，此为父母缘深之相。日月角饱满说明您与父母的关系和谐，能够得到父母的关爱和支持。同时也代表您的家庭教育良好，为人生打下了坚实的基础。建议常回家看看，孝敬父母，家和万事兴。",
    ],
    中: [
      "您的父母宫日月角表现中等，与父母的关系平稳。建议多与父母沟通交流，理解他们的想法和感受，增进亲子感情。在力所能及的范围内多关心父母的健康和生活。",
    ],
    凶: [
      "您的父母宫日月角略显不足，与父母的关系可能需要更多经营。建议主动与父母沟通，化解可能存在的误解。多表达对父母的感恩之情，用实际行动孝敬父母，亲情关系将逐渐改善。",
    ],
  },
  奴仆宫: {
    吉: [
      "您的奴仆宫下巴圆润饱满，此为晚年安泰之相。下巴圆润有肉说明您晚年运势良好，能够享受天伦之乐。同时也代表您在管理下属方面有天赋，容易得到他人的尊重和服从。建议善待身边的人，广结善缘，晚年生活将更加幸福美满。",
    ],
    中: [
      "您的奴仆宫下巴表现中等，晚年运势平稳。建议从现在开始做好养老规划，注重健康管理和财务规划，为晚年生活打好基础。同时维护好人际关系，老来有伴才是真正的幸福。",
    ],
    凶: [
      "您的奴仆宫下巴略显不足，晚年方面需要提前规划。建议从年轻时就开始注重养生保健和财务积累，为晚年生活做好充分准备。同时多培养兴趣爱好，丰富精神生活，晚年将更加充实快乐。",
    ],
  },
};

// ============= 手相解读文案库 =============

const PALM_LINE_TEMPLATES: Record<string, Record<string, string[]>> = {
  生命线: {
    吉: [
      "您的生命线深长有力，弧度优美，此为健康长寿之相。生命线是手相三大主线之首，深长的生命线说明您生命力旺盛，体质强健，精力充沛。弧度优美代表性格开朗，适应能力强，能够从容面对生活中的各种挑战。建议保持积极的生活方式，规律运动，健康将长久相伴。",
    ],
    中: [
      "您的生命线长度和深度适中，整体健康运势平稳。虽然生命线不算特别深长，但整体走势良好，说明您的身体状况尚可。建议注意日常保健，保持规律的作息和适量的运动，饮食注意营养均衡，健康状况将持续改善。",
    ],
    凶: [
      "您的生命线略显短浅，健康方面需要多加关注。但请不要过于担心，生命线短并不代表寿命短，它更多反映的是生命力和精力状况。建议加强体育锻炼，增强体质，注意饮食健康，定期体检。通过后天的努力，完全可以改善健康状况。",
    ],
  },
  智慧线: {
    吉: [
      "您的智慧线清晰深长，走势平稳，此为聪明睿智之相。智慧线代表一个人的思维能力和学习能力，深长的智慧线说明您头脑聪明，思维敏捷，有很强的分析和判断能力。在学业和事业上都容易取得优异的成绩。建议充分发挥自己的智慧优势，在专业领域深耕细作，必将有所成就。",
    ],
    中: [
      "您的智慧线长度和深度中等，思维能力尚可。虽然不算特别突出，但通过持续学习和训练，完全可以提升自己的认知能力。建议多读书、多思考，培养批判性思维，同时注重实践经验的积累，智慧将不断增长。",
    ],
    凶: [
      "您的智慧线略显不足，在学习和思考方面可能需要更多努力。但这并不代表您不聪明，只是可能需要更多的时间和耐心来掌握新知识。建议找到适合自己的学习方法，循序渐进，同时多向他人请教，集思广益。",
    ],
  },
  感情线: {
    吉: [
      "您的感情线深长优美，此为感情丰富之相。感情线代表一个人的情感世界和人际关系，深长的感情线说明您感情丰富，善于表达爱意，在感情生活中容易获得幸福。您对待感情真诚专一，能够建立深厚的情感纽带。建议珍惜身边的感情，用心经营，幸福将长久相伴。",
    ],
    中: [
      "您的感情线表现中等，感情运势平稳。在感情方面可能比较理性，不会过于感性。建议在保持理性的同时，也要学会表达自己的情感，让身边的人感受到您的关爱。真诚的沟通是维系感情的关键。",
    ],
    凶: [
      "您的感情线略显不足，感情方面可能会遇到一些波折。建议学会更好地表达自己的情感，同时也要学会倾听和理解他人。在择偶时不要过于挑剔，注重内在品质，真诚的感情才能经得起考验。",
    ],
  },
  事业线: {
    吉: [
      "您的事业线清晰有力，直达中指根部，此为事业有成之相。事业线代表一个人的事业发展和社会地位，清晰有力的事业线说明您在事业上有明确的目标和强大的执行力。中年以后事业将达到巅峰，社会地位也会不断提升。建议坚持自己的事业理想，勇于开拓创新。",
    ],
    中: [
      "您的事业线表现中等，事业发展平稳。虽然事业线不算特别明显，但这说明您的事业发展更多依赖于自身的努力和选择。建议制定清晰的职业规划，持续提升专业能力，同时注重人脉的积累，事业将稳步发展。",
    ],
    凶: [
      "您的事业线略显模糊，事业方面可能需要更多的努力和规划。建议找到自己真正热爱的事业方向，全身心投入。同时注重学习和成长，提升自己的竞争力。记住，成功没有捷径，只有脚踏实地才能走得更远。",
    ],
  },
  婚姻线: {
    吉: [
      "您的婚姻线清晰且数量适当，此为婚姻美满之相。婚姻线代表一个人的婚姻状况和感情归宿，清晰的婚姻线说明您在婚姻方面运势良好，容易找到合适的伴侣，婚后生活和谐幸福。建议在选择伴侣时注重三观的契合，用心经营婚姻关系。",
    ],
    中: [
      "您的婚姻线表现中等，婚姻运势平稳。在婚姻方面可能需要更多的耐心和经营。建议在择偶时不要急于求成，多了解对方的性格和价值观，确保双方能够长久相处。婚后也要注重沟通和理解，共同成长。",
    ],
    凶: [
      "您的婚姻线略显不足，婚姻方面需要更加用心。建议在感情中学会包容和理解，不要因为小事而影响大局。同时注重自身的成长和提升，让自己变得更加优秀，自然会吸引到合适的伴侣。",
    ],
  },
};

const PALM_HILL_TEMPLATES: Record<string, Record<string, string[]>> = {
  木星丘: {
    吉: ["木星丘隆起饱满，说明您具有领导才能和进取心，在事业上容易取得成功。您天生具有号召力，能够带领团队达成目标。"],
    中: ["木星丘表现中等，说明您有一定的领导潜力，但需要更多的锻炼和实践。建议多承担责任，培养领导能力。"],
    凶: ["木星丘略显平坦，在领导力方面需要更多培养。建议多参加团队活动，学习管理知识，逐步提升自己的领导能力。"],
  },
  土星丘: {
    吉: ["土星丘适度隆起，说明您性格稳重，有很强的责任感和自律能力。在学术研究或专业技术领域容易取得成就。"],
    中: ["土星丘表现中等，说明您的自律能力尚可。建议培养更强的时间管理和自我约束能力，这将有助于事业发展。"],
    凶: ["土星丘略显不足，可能在自律方面需要加强。建议制定明确的目标和计划，养成良好的习惯，逐步提升自控力。"],
  },
  太阳丘: {
    吉: ["太阳丘饱满隆起，说明您具有艺术天赋和创造力，在文艺、设计等领域有很大的发展潜力。同时也代表您的人缘好，容易获得他人的喜爱。"],
    中: ["太阳丘表现中等，说明您有一定的艺术感知力。建议多接触艺术和文化，培养审美能力，这将丰富您的人生体验。"],
    凶: ["太阳丘略显平坦，在艺术创造方面可能需要更多培养。建议多欣赏艺术作品，参加文化活动，逐步提升自己的审美水平。"],
  },
  水星丘: {
    吉: ["水星丘饱满有力，说明您口才出众，善于沟通和表达。在商业、外交、教育等领域有很大的优势。同时也代表您的财商较高。"],
    中: ["水星丘表现中等，说明您的沟通能力尚可。建议多练习演讲和写作，提升表达能力，这将在事业和生活中带来很大帮助。"],
    凶: ["水星丘略显不足，在沟通表达方面需要更多练习。建议参加演讲培训，多与人交流，逐步提升自己的沟通技巧。"],
  },
  金星丘: {
    吉: ["金星丘丰满有弹性，说明您精力充沛，热爱生活，对美好事物有很强的感知力。同时也代表您的感情丰富，善于关爱他人。"],
    中: ["金星丘表现中等，说明您的生命力和热情处于正常水平。建议多参加户外活动，培养积极的生活态度，让生活更加丰富多彩。"],
    凶: ["金星丘略显不足，可能精力不够充沛。建议加强体育锻炼，注意营养补充，保持充足的睡眠，逐步恢复活力。"],
  },
  太阴丘: {
    吉: ["太阴丘饱满隆起，说明您想象力丰富，直觉敏锐，有很强的创造性思维。在文学、音乐、心理学等领域有独特的天赋。"],
    中: ["太阴丘表现中等，说明您有一定的想象力和直觉。建议多进行创造性思维训练，如写作、绘画等，激发内在的创造力。"],
    凶: ["太阴丘略显平坦，想象力方面可能需要更多培养。建议多阅读文学作品，接触不同的文化和思想，拓展思维的边界。"],
  },
  第一火星丘: {
    吉: ["第一火星丘隆起有力，说明您勇气十足，敢于面对挑战，有很强的行动力和决断力。在竞争激烈的环境中能够脱颖而出。"],
    中: ["第一火星丘表现中等，说明您有一定的勇气和行动力。建议在面对挑战时更加果断，相信自己的判断，勇敢地迈出第一步。"],
    凶: ["第一火星丘略显不足，在勇气和行动力方面需要加强。建议多尝试新事物，走出舒适区，逐步培养自信和勇气。"],
  },
  第二火星丘: {
    吉: ["第二火星丘饱满有力，说明您意志坚强，有很强的忍耐力和抗压能力。在逆境中能够坚持不懈，最终取得成功。"],
    中: ["第二火星丘表现中等，说明您有一定的抗压能力。建议在面对困难时保持冷静，学会调节情绪，逐步增强心理韧性。"],
    凶: ["第二火星丘略显不足，在抗压能力方面需要提升。建议学习压力管理技巧，如冥想、运动等，同时培养积极的心态。"],
  },
};

// ============= 总结文案库 =============

const FACE_OVERALL_TEMPLATES = {
  excellent: [
    "综观您的面相，整体呈现出福禄双全、运势亨通之象。多个宫位评分优秀，尤其在{topPalaces}方面表现突出，预示着您在人生的各个领域都将有所建树。您天生具有{faceType}的特质，性格{personality}，善于把握机遇，在事业和生活中都能游刃有余。古人云:\"相由心生\"，您的面相正是内心善良、智慧的外在体现。建议继续保持积极向上的心态，广结善缘，行善积德，运势将更加旺盛，前程似锦，福泽绵长。",
  ],
  good: [
    "综观您的面相，整体运势良好，多数宫位表现不错。{topPalaces}方面尤为突出，显示出您在这些领域有着天然的优势。您的{faceType}面相特征明显，性格{personality}，做事有条理，为人处世得体。虽然个别宫位还有提升空间，但整体走势积极向上。建议在保持优势的同时，注意弥补不足之处，全面发展，人生将更加圆满。",
  ],
  average: [
    "综观您的面相，整体运势平稳，各宫位表现均衡。{topPalaces}方面相对突出，可以作为重点发展方向。您的{faceType}面相显示性格{personality}，为人踏实稳重。虽然目前运势处于蓄力期，但只要持之以恒，勤勉努力，必能积少成多，厚积薄发。建议制定明确的人生目标，一步一个脚印地前进，同时注重修身养性，提升内在修养，运势将逐渐好转。",
  ],
  belowAverage: [
    "综观您的面相，部分宫位需要注意调理，但请不要过于担忧。命运掌握在自己手中，通过后天的努力完全可以改善运势。{topPalaces}方面仍有不错的表现，可以作为突破口。您的{faceType}面相虽然某些方面有所不足，但性格{personality}，这是您的宝贵品质。建议保持乐观积极的心态，多行善事，广结善缘，注重健康养生，运势必将逐步好转。记住，相由心生，心善则相善，心正则运正。",
  ],
};

const PALM_OVERALL_TEMPLATES = {
  excellent: [
    "综观您的手相，整体呈现出吉祥如意之象。{topLines}表现尤为突出，预示着您在健康、事业和感情方面都将有出色的表现。您的{handType}手型特征明显，说明您{personality}。多条纹路深长有力，丘位饱满隆起，这是生命力旺盛、运势亨通的标志。建议充分发挥自己的优势，在擅长的领域深耕细作，同时保持谦逊和感恩的心态，好运将持续相伴。",
  ],
  good: [
    "综观您的手相，整体运势良好。{topLines}方面表现突出，显示出您在这些领域有着天然的优势。您的{handType}手型说明您{personality}，做事认真负责。虽然个别纹路还有提升空间，但整体走势积极向上。建议在保持优势的同时，注意全面发展，人生将更加精彩。",
  ],
  average: [
    "综观您的手相，整体运势平稳，各纹路和丘位表现均衡。{topLines}方面相对突出，可以重点关注。您的{handType}手型显示您{personality}，为人踏实可靠。建议制定明确的人生规划，持续努力，同时注重健康管理，运势将稳步提升。",
  ],
  belowAverage: [
    "综观您的手相，部分纹路需要关注，但请保持积极心态。手相会随着人生经历而变化，通过努力完全可以改善。{topLines}方面仍有不错的表现，这是您的优势所在。您的{handType}手型虽然某些方面有所不足，但{personality}是您的宝贵品质。建议注重健康养生，积极锻炼，保持乐观心态，运势必将好转。",
  ],
};

// 脸型对应的性格特征
const FACE_TYPE_PERSONALITY: Record<string, string> = {
  金型脸: "坚毅果断，有领导力，做事雷厉风行",
  木型脸: "温文尔雅，有学识，善于思考和分析",
  水型脸: "聪明灵活，善于交际，适应能力强",
  火型脸: "热情开朗，有创造力，行动力强",
  土型脸: "稳重踏实，有耐心，为人忠厚可靠",
};

// 手型对应的性格特征
const HAND_TYPE_PERSONALITY: Record<string, string> = {
  金型手: "意志坚定，有原则，做事有条理",
  木型手: "思维活跃，有创意，善于学习新事物",
  水型手: "灵活多变，善于沟通，人际关系好",
  火型手: "精力充沛，有激情，行动力强",
  土型手: "踏实稳重，有耐心，值得信赖",
};

// ============= 报告生成函数 =============

/**
 * 生成面相/手相解读报告（本地模板引擎）
 */
export async function generateAIInterpretation(
  calculationResult: CalculationResult,
  serviceType: "face" | "palm"
): Promise<AIInterpretationResult> {
  const sections: Array<{ title: string; content: string; score: number }> = [];
  let totalScore = 0;
  let count = 0;

  const entries = Object.entries(calculationResult);

  for (const [name, data] of entries) {
    totalScore += data.score;
    count++;

    let content: string;

    if (serviceType === "face") {
      content = getFaceInterpretation(name, data.category, data.score, data.interpretations);
    } else {
      content = getPalmInterpretation(name, data.category, data.score, data.interpretations);
    }

    sections.push({
      title: `${name}分析`,
      content,
      score: data.score,
    });
  }

  const avgScore = count > 0 ? Math.round(totalScore / count) : 70;

  // 获取评分最高的宫位/纹路
  const sortedEntries = entries.sort((a, b) => b[1].score - a[1].score);
  const topNames = sortedEntries.slice(0, 3).map(([name]) => name);

  // 生成综合总结
  const overallSummary = generateOverallSummary(
    serviceType,
    avgScore,
    topNames,
    calculationResult
  );

  return {
    overallSummary,
    sections,
  };
}

/**
 * 获取面相宫位解读
 */
function getFaceInterpretation(
  palaceName: string,
  category: string,
  score: number,
  ruleInterpretations: string[]
): string {
  const templates = FACE_PALACE_TEMPLATES[palaceName];
  if (templates && templates[category]) {
    const options = templates[category];
    // 根据分数选择模板
    const idx = Math.min(Math.floor((score % 100) / (100 / options.length)), options.length - 1);
    return options[idx];
  }

  // 如果没有预设模板，使用规则库的解读拼接
  if (ruleInterpretations.length > 0) {
    const baseContent = ruleInterpretations.join("。") + "。";
    if (category === "吉") {
      return `${palaceName}表现优秀。${baseContent}整体来看，这方面运势良好，建议继续保持积极的状态。`;
    } else if (category === "凶") {
      return `${palaceName}方面需要注意。${baseContent}建议多加留意，通过调整心态和行为，运势可以逐步改善。`;
    } else {
      return `${palaceName}表现中等。${baseContent}建议在这方面多下功夫，持续提升，运势将逐渐好转。`;
    }
  }

  return `${palaceName}的整体表现${category === "吉" ? "良好" : category === "凶" ? "需要关注" : "中等"}，评分为${score}分。`;
}

/**
 * 获取手相纹路/丘位解读
 */
function getPalmInterpretation(
  name: string,
  category: string,
  score: number,
  ruleInterpretations: string[]
): string {
  // 先检查纹路模板
  const lineTemplates = PALM_LINE_TEMPLATES[name];
  if (lineTemplates && lineTemplates[category]) {
    const options = lineTemplates[category];
    const idx = Math.min(Math.floor((score % 100) / (100 / options.length)), options.length - 1);
    return options[idx];
  }

  // 再检查丘位模板
  const hillTemplates = PALM_HILL_TEMPLATES[name];
  if (hillTemplates && hillTemplates[category]) {
    const options = hillTemplates[category];
    const idx = Math.min(Math.floor((score % 100) / (100 / options.length)), options.length - 1);
    return options[idx];
  }

  // 使用规则库解读
  if (ruleInterpretations.length > 0) {
    return ruleInterpretations.join("。") + "。";
  }

  return `${name}的整体表现${category === "吉" ? "良好" : category === "凶" ? "需要关注" : "中等"}，评分为${score}分。`;
}

/**
 * 生成综合总结
 */
function generateOverallSummary(
  serviceType: "face" | "palm",
  avgScore: number,
  topNames: string[],
  calculationResult: CalculationResult
): string {
  // 确定评分等级
  let level: "excellent" | "good" | "average" | "belowAverage";
  if (avgScore >= 80) level = "excellent";
  else if (avgScore >= 70) level = "good";
  else if (avgScore >= 60) level = "average";
  else level = "belowAverage";

  let template: string;
  let faceType = "";
  let personality = "";

  if (serviceType === "face") {
    const templates = FACE_OVERALL_TEMPLATES[level];
    template = templates[0];
    faceType = "土型脸"; // 默认值，实际会从特征中获取
    personality = FACE_TYPE_PERSONALITY[faceType] || "稳重踏实，为人可靠";

    // 替换占位符
    template = template
      .replace("{topPalaces}", topNames.join("、"))
      .replace("{faceType}", faceType)
      .replace("{personality}", personality);
  } else {
    const templates = PALM_OVERALL_TEMPLATES[level];
    template = templates[0];
    const handType = "土型手";
    personality = HAND_TYPE_PERSONALITY[handType] || "踏实稳重，值得信赖";

    template = template
      .replace("{topLines}", topNames.join("、"))
      .replace("{handType}", handType)
      .replace("{personality}", personality);
  }

  return template;
}

/**
 * 带重试机制的解读生成（本地引擎不需要重试，保持接口兼容）
 */
export async function generateAIInterpretationWithRetry(
  calculationResult: CalculationResult,
  serviceType: "face" | "palm",
  maxRetries: number = 3
): Promise<AIInterpretationResult> {
  // 本地引擎不会失败，直接调用即可
  return await generateAIInterpretation(calculationResult, serviceType);
}
